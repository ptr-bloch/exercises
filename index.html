<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pluralization Trainer</title>
<style>
  :root{--bg:#0f1220;--card:#171a2b;--text:#e8ecff;--muted:#aab0d6;--accent:#6aa7ff;--bad:#ff6b6b;--good:#36d399}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:8px}
  header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  h1{font-size:16px;margin:0;flex:1}
  .pill{background:var(--card);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  .board{position:relative;height:84vh;min-height:560px;border:1px solid #242743;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
  .cloud{position:relative;flex:1;min-height:360px}
  .badge{position:absolute;top:6px;left:8px;background:#0e1328;border:1px solid #27305a;color:var(--muted);font-size:11px;padding:2px 8px;border-radius:999px;z-index:2}
  .status{position:absolute;top:6px;right:8px;display:flex;gap:6px;z-index:2}
  .status .s{background:#0e1328;border:1px solid #27305a;color:var(--muted);font-size:11px;padding:2px 8px;border-radius:999px}
  .status .ok{color:var(--good);border-color:#1f5a47}
  .cloud.locked{filter:grayscale(0.2) opacity(0.8)}
  .overlay{pointer-events:auto;position:absolute;inset:0;display:none}
  .overlay.show{display:block}
  .target{padding:6px;background:var(--card);border-top:1px solid #242743;display:flex;flex-direction:column;align-items:center}
  .word{font-size:20px;font-weight:bold}
  .small{font-size:12px;color:var(--muted)}
  .opt{position:absolute;padding:8px 12px;border-radius:12px;background:#141830;user-select:none;white-space:nowrap;transition:transform .15s ease, box-shadow .15s ease, opacity .2s ease}
  .opt .tag{font-size:10px;opacity:.7;margin-left:6px}
  .float{animation:float 8s ease-in-out infinite;will-change:transform}
  @keyframes float{0%{transform:translate(0,0)}50%{transform:translate(var(--dx,6px),var(--dy,6px))}100%{transform:translate(0,0)}}
  .msg{font-size:12px;color:var(--muted);margin-top:4px;max-width:1000px;text-align:center}
  .msg.bad{color:var(--bad)}
  .msg.good{color:var(--good)}
  .count{font-weight:700;margin-left:6px}
  button{padding:4px 8px;margin:2px}
  /* ===== Animations ===== */
  .opt.yay{animation:pop .45s ease-out}
  @keyframes pop{0%{transform:scale(1)}40%{transform:scale(1.18)}100%{transform:scale(1)}}
  .opt.nay{animation:shake .45s ease}
  @keyframes shake{0%,100%{transform:translateX(0)}15%{transform:translateX(-6px)}30%{transform:translateX(6px)}45%{transform:translateX(-5px)}60%{transform:translateX(5px)}75%{transform:translateX(-3px)}}
  .opt.flash-good{box-shadow:0 0 0 0 rgba(54,211,153,.6);animation:goodglow .6s ease}
  @keyframes goodglow{to{box-shadow:0 0 30px 12px rgba(54,211,153,0)}}
  .opt.flash-bad{box-shadow:0 0 0 0 rgba(255,107,107,.7);animation:badglow .6s ease}
  @keyframes badglow{to{box-shadow:0 0 30px 12px rgba(255,107,107,0)}}
  /* Negative smile overlay */
  .neg-smile{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:5vw;color:var(--bad);pointer-events:none;opacity:0;transform:scale(0);transition:transform 1s ease, opacity 1s ease;z-index:1000}
  .neg-smile.show{opacity:0.8;transform:scale(10)}
  /* Fireworks (correct) */
  .fx{position:absolute;pointer-events:none;left:0;top:0;transform:translate(-50%,-50%);z-index:900}
  .fx i{position:absolute;width:6px;height:6px;border-radius:50%;opacity:0;animation:explode .8s ease-out forwards}
  .fx.ok i{background:var(--good)}
  @keyframes explode{0%{opacity:1;transform:rotate(calc(var(--a)*1deg)) translate(0) scale(1)}80%{opacity:.9}100%{opacity:0;transform:rotate(calc(var(--a)*1deg)) translate(var(--d)) scale(.6)}}
  /* Hide animation for non-selected after solve */
  .vanish{animation:vanish .25s ease forwards}
  @keyframes vanish{to{opacity:0;transform:scale(.9)}}
  /* Play button */
  .playbtn{margin-top:4px; font-size:16px; padding:10px 18px; border-radius:999px; border:1px solid #2b3157; background:#121630; color:var(--text); cursor:pointer}
  .playbtn:disabled{opacity:.5; cursor:not-allowed}
  /* Start screen */
  .start-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(10,12,24,.85);backdrop-filter:blur(2px);z-index:1200}
  .start-panel{display:flex;flex-direction:column;gap:16px;align-items:center}
  .start-btn{width:200px;height:200px;border-radius:50%;border:2px solid #2b3157;background:#0e1328;color:var(--text);font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .start-btn:active{transform:scale(.98)}
  .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .chip{border:1px solid #2b3157;background:#0e1328;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:14px}
  .chip[aria-pressed="true"]{background:#1a2247;border-color:#3c4b93}
  .toggle{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
  .link{color:var(--accent);cursor:pointer;text-decoration:underline}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Pluralization Trainer</h1>
    <div class="pill" id="round">0/10</div>
    <div class="pill" id="score">0/0</div>
    <div class="pill" id="avg">Avg: ‚Äî</div>
  </header>
  <div class="board" id="board">
    <div class="cloud" id="cloud">
      <div class="badge" id="badge">Find: translation ‚Üí plural</div>
      <div class="status" id="status"><div class="s" id="sRu">ru</div><div class="s" id="sForm">plural</div></div>
    </div>
    <div class="overlay" id="overlay" aria-hidden="true"></div>
    <div class="neg-smile" id="negSmile">‚òπÔ∏è</div>
    <!-- Start overlay -->
    <div class="start-overlay" id="startOverlay">
      <div class="start-panel" id="startPanel">
        <div class="row" id="countRow" aria-label="Word count">
          <button class="chip" data-n="10" aria-pressed="true">10</button>
          <button class="chip" data-n="20">20</button>
          <button class="chip" data-n="35">35</button>
          <button class="chip" data-n="50">50</button>
        </div>
        <label class="toggle"><input type="checkbox" id="toggleRu" checked /> Include translations (RU)</label>
        <div class="row">
          <span class="link" id="viewResultsLink">View results</span>
        </div>
        <button class="start-btn" id="startBtn">Start</button>
      </div>
    </div>
    <div class="target">
      <div class="small" id="direction">Step 1: choose translation ‚Üí Step 2: choose plural</div>
      <button class="playbtn" id="playBtn" title="Play pronunciation" aria-label="Play pronunciation">Repeat</button>
      <div class="msg" id="tip">Pick the correct <b>translation</b> first. Wrong = 10s lock with rule (EN/RU).</div>
      <div>
        <button id="restart">Restart</button>
      </div>
    </div>
  </div>
</div>
<script>
// Short aliases for DOM lookups
const ge = id => document.getElementById(id);
const qs = sel => document.querySelector(sel);

// dataset index constants
const S=0,P=1,R=2,RU=3;

// ---------------- Rules ----------------
const RULES = {
  addS: { en: "Regular nouns add -s (book ‚Üí books).", ru: "–û–±—ã—á–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–∑—É—é—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ —Å –ø–æ–º–æ—â—å—é -s (book ‚Üí books)." },
  yToIes: { en: "Consonant + y ‚Üí ies (city ‚Üí cities).", ru: "–°–æ–≥–ª–∞—Å–Ω–∞—è + y ‚Üí ies (city ‚Üí cities)." },
  sibilantEs: { en: "Ends in s, x, z, ch, sh ‚Üí add -es (bus ‚Üí buses).", ru: "–û–∫–æ–Ω—á–∞–Ω–∏–µ –Ω–∞ s, x, z, ch, sh ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è -es (bus ‚Üí buses)." },
  fToVes: { en: "-f/-fe ‚Üí -ves (wife ‚Üí wives, knife ‚Üí knives).", ru: "–û–∫–æ–Ω—á–∞–Ω–∏—è -f/-fe –º–µ–Ω—è—é—Ç—Å—è –Ω–∞ -ves (wife ‚Üí wives, knife ‚Üí knives)." },
  oEs: { en: "Some -o nouns take -es (tomato ‚Üí tomatoes); many take -s (photo ‚Üí photos).", ru: "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–ª–æ–≤–∞ –Ω–∞ -o –ø–æ–ª—É—á–∞—é—Ç -es (tomato ‚Üí tomatoes); –º–Ω–æ–≥–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ -s (photo ‚Üí photos)." },
  invariant: { en: "Same form in singular and plural (fish ‚Üí fish, series ‚Üí series).", ru: "–§–æ—Ä–º–∞ –µ–¥. –∏ –º–Ω. —á–∏—Å–ª–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç (fish ‚Üí fish, series ‚Üí series)." },
  irregular: { en: "Irregular change (man ‚Üí men, mouse ‚Üí mice, person ‚Üí people).", ru: "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (man ‚Üí men, mouse ‚Üí mice, person ‚Üí people)." },
  latinGreek: { en: "Classical plural (analysis ‚Üí analyses, criterion ‚Üí criteria).", ru: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—ã (analysis ‚Üí analyses, criterion ‚Üí criteria)." },
  translation: { en: "Choose the correct Russian translation of the noun (meaning).", ru: "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫."}
};

// ---------------- Unified dataset: WORDS ----------------
// Each item now is an array: [singular, plural, ruleKey, russian]
const WORDS = [
  // Irregulars
  ['man','men','irregular','–º—É–∂—á–∏–Ω–∞'],
  ['woman','women','irregular','–∂–µ–Ω—â–∏–Ω–∞'],
  ['child','children','irregular','—Ä–µ–±—ë–Ω–æ–∫'],
  ['person','people','irregular','—á–µ–ª–æ–≤–µ–∫'],
  ['mouse','mice','irregular','–º—ã—à—å'],
  ['foot','feet','irregular','—Å—Ç—É–ø–Ω—è'],
  ['tooth','teeth','irregular','–∑—É–±'],
  ['goose','geese','irregular','–≥—É—Å—å'],
  // f/fe ‚Üí ves
  ['leaf','leaves','fToVes','–ª–∏—Å—Ç'],
  ['wife','wives','fToVes','–∂–µ–Ω–∞'],
  ['life','lives','fToVes','–∂–∏–∑–Ω—å'],
  ['knife','knives','fToVes','–Ω–æ–∂'],
  ['half','halves','fToVes','–ø–æ–ª–æ–≤–∏–Ω–∞'],
  ['shelf','shelves','fToVes','–ø–æ–ª–∫–∞'],
  // Sibilant + es
  ['bus','buses','sibilantEs','–∞–≤—Ç–æ–±—É—Å'],
  ['box','boxes','sibilantEs','–∫–æ—Ä–æ–±–∫–∞'],
  ['church','churches','sibilantEs','—Ü–µ—Ä–∫–æ–≤—å'],
  ['class','classes','sibilantEs','–∫–ª–∞—Å—Å'],
  ['glass','glasses','sibilantEs','—Å—Ç–∞–∫–∞–Ω'],
  ['watch','watches','sibilantEs','—á–∞—Å—ã'],
  ['match','matches','sibilantEs','—Å–ø–∏—á–∫–∞'],
  ['beach','beaches','sibilantEs','–ø–ª—è–∂'],
  ['dress','dresses','sibilantEs','–ø–ª–∞—Ç—å–µ'],
  ['kiss','kisses','sibilantEs','–ø–æ—Ü–µ–ª—É–π'],
  // y ‚Üí ies
  ['city','cities','yToIes','–≥–æ—Ä–æ–¥'],
  ['story','stories','yToIes','—Ä–∞—Å—Å–∫–∞–∑'],
  ['baby','babies','yToIes','–º–ª–∞–¥–µ–Ω–µ—Ü'],
  ['berry','berries','yToIes','—è–≥–æ–¥–∞'],
  ['lady','ladies','yToIes','–¥–∞–º–∞'],
  ['country','countries','yToIes','—Å—Ç—Ä–∞–Ω–∞'],
  ['family','families','yToIes','—Å–µ–º—å—è'],
  ['party','parties','yToIes','–≤–µ—á–µ—Ä–∏–Ω–∫–∞'],
  ['body','bodies','yToIes','—Ç–µ–ª–æ'],
  ['library','libraries','yToIes','–±–∏–±–ª–∏–æ—Ç–µ–∫–∞'],
  ['sky','skies','yToIes','–Ω–µ–±–æ'],
  // -o words
  ['tomato','tomatoes','oEs','–ø–æ–º–∏–¥–æ—Ä'],
  ['potato','potatoes','oEs','–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å'],
  ['hero','heroes','oEs','–≥–µ—Ä–æ–π'],
  ['echo','echoes','oEs','—ç—Ö–æ'],
  ['mango','mangoes','oEs','–º–∞–Ω–≥–æ'],
  ['volcano','volcanoes','oEs','–≤—É–ª–∫–∞–Ω'],
  ['photo','photos','addS','—Ñ–æ—Ç–æ'],
  ['piano','pianos','addS','–ø–∏–∞–Ω–∏–Ω–æ'],
  ['radio','radios','addS','—Ä–∞–¥–∏–æ'],
  ['video','videos','addS','–≤–∏–¥–µ–æ'],
  ['zoo','zoos','addS','–∑–æ–æ–ø–∞—Ä–∫'],
  ['kangaroo','kangaroos','addS','–∫–µ–Ω–≥—É—Ä—É'],
  ['zero','zeros','addS','–Ω–æ–ª—å'],
  // Invariant (zero-plural)
  ['fish','fish','invariant','—Ä—ã–±–∞'],
  ['sheep','sheep','invariant','–æ–≤—Ü–∞'],
  ['deer','deer','invariant','–æ–ª–µ–Ω—å'],
  ['species','species','invariant','–≤–∏–¥'],
  ['series','series','invariant','—Å–µ—Ä–∏—è'],
  ['aircraft','aircraft','invariant','—Å–∞–º–æ–ª—ë—Ç'],
  ['salmon','salmon','invariant','–ª–æ—Å–æ—Å—å'],
  ['trout','trout','invariant','—Ñ–æ—Ä–µ–ª—å'],
  ['swine','swine','invariant','—Å–≤–∏–Ω—å—è'],
  ['moose','moose','invariant','–ª–æ—Å—å'],
  ['bison','bison','invariant','–±–∏–∑–æ–Ω'],
  ['offspring','offspring','invariant','–ø–æ—Ç–æ–º—Å—Ç–≤–æ'],
  ['ice','ice','invariant','–ª—ë–¥'],
  // Regular addS (sample)
  ['book','books','addS','–∫–Ω–∏–≥–∞'],
  ['cat','cats','addS','–∫–æ—à–∫–∞'],
  ['dog','dogs','addS','—Å–æ–±–∞–∫–∞'],
  ['car','cars','addS','–º–∞—à–∏–Ω–∞'],
  ['pen','pens','addS','—Ä—É—á–∫–∞'],
  ['house','houses','addS','–¥–æ–º'],
  ['tree','trees','addS','–¥–µ—Ä–µ–≤–æ'],
  ['flower','flowers','addS','—Ü–≤–µ—Ç–æ–∫'],
  ['river','rivers','addS','—Ä–µ–∫–∞'],
  ['school','schools','addS','—à–∫–æ–ª–∞'],
  ['chair','chairs','addS','—Å—Ç—É–ª'],
  ['desk','desks','addS','–ø–∏—Å—å–º–µ–Ω–Ω—ã–π —Å—Ç–æ–ª'],
  ['shoe','shoes','addS','—Ç—É—Ñ–ª—è'],
  ['door','doors','addS','–¥–≤–µ—Ä—å'],
  ['hat','hats','addS','—à–ª—è–ø–∞'],
  ['apple','apples','addS','—è–±–ª–æ–∫–æ'],
  ['orange','oranges','addS','–∞–ø–µ–ª—å—Å–∏–Ω'],
  ['banana','bananas','addS','–±–∞–Ω–∞–Ω'],
  ['plate','plates','addS','—Ç–∞—Ä–µ–ª–∫–∞'],
  ['cup','cups','addS','—á–∞—à–∫–∞'],
  ['day','days','addS','–¥–µ–Ω—å'],
  ['toy','toys','addS','–∏–≥—Ä—É—à–∫–∞'],
  ['key','keys','addS','–∫–ª—é—á'],
  ['valley','valleys','addS','–¥–æ–ª–∏–Ω–∞'],
  ['monkey','monkeys','addS','–æ–±–µ–∑—å—è–Ω–∞'],
  ['donkey','donkeys','addS','–æ—Å—ë–ª'],
  ['boy','boys','addS','–º–∞–ª—å—á–∏–∫'],
  ['guy','guys','addS','–ø–∞—Ä–µ–Ω—å'],
  ['holiday','holidays','addS','–ø—Ä–∞–∑–¥–Ω–∏–∫'],
  ['chimney','chimneys','addS','–¥—ã–º–æ—Ö–æ–¥'],
  ['journey','journeys','addS','–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ'],
  ['essay','essays','addS','—ç—Å—Å–µ'],
  ['delay','delays','addS','–∑–∞–¥–µ—Ä–∂–∫–∞'],
  ['roof','roofs','addS','–∫—Ä—ã—à–∞'],
  ['bag','bags','addS','—Å—É–º–∫–∞'],
  ['ball','balls','addS','–º—è—á'],
  ['bank','banks','addS','–±–∞–Ω–∫'],
  ['bed','beds','addS','–∫—Ä–æ–≤–∞—Ç—å'],
  ['bell','bells','addS','–∫–æ–ª–æ–∫–æ–ª'],
  ['bike','bikes','addS','–≤–µ–ª–æ—Å–∏–ø–µ–¥'],
  ['bird','birds','addS','–ø—Ç–∏—Ü–∞'],
  ['boat','boats','addS','–ª–æ–¥–∫–∞'],
  ['bridge','bridges','addS','–º–æ—Å—Ç'],
  ['brother','brothers','addS','–±—Ä–∞—Ç'],
  ['cake','cakes','addS','—Ç–æ—Ä—Ç'],
  ['call','calls','addS','–∑–≤–æ–Ω–æ–∫'],
  ['cap','caps','addS','–∫–µ–ø–∫–∞'],
  ['card','cards','addS','–∫–∞—Ä—Ç–∞'],
  ['carpet','carpets','addS','–∫–æ–≤—ë—Ä'],
  ['chicken','chickens','addS','–∫—É—Ä–∏—Ü–∞'],
  ['clock','clocks','addS','—á–∞—Å—ã'],
  ['cloud','clouds','addS','–æ–±–ª–∞–∫–æ'],
  ['coat','coats','addS','–ø–∞–ª—å—Ç–æ'],
  ['color','colors','addS','—Ü–≤–µ—Ç'],
  ['computer','computers','addS','–∫–æ–º–ø—å—é—Ç–µ—Ä'],
  ['cook','cooks','addS','–ø–æ–≤–∞—Ä'],
  ['dad','dads','addS','–ø–∞–ø–∞'],
  ['dance','dances','addS','—Ç–∞–Ω–µ—Ü'],
  ['doll','dolls','addS','–∫—É–∫–ª–∞'],
  ['dream','dreams','addS','—Å–æ–Ω'],
  ['drink','drinks','addS','–Ω–∞–ø–∏—Ç–æ–∫'],
  ['ear','ears','addS','—É—Ö–æ'],
  ['egg','eggs','addS','—è–π—Ü–æ'],
  ['eye','eyes','addS','–≥–ª–∞–∑'],
  ['face','faces','addS','–ª–∏—Ü–æ'],
  ['farm','farms','addS','—Ñ–µ—Ä–º–∞'],
  ['father','fathers','addS','–æ—Ç–µ—Ü'],
  ['field','fields','addS','–ø–æ–ª–µ'],
  ['finger','fingers','addS','–ø–∞–ª–µ—Ü'],
  ['flag','flags','addS','—Ñ–ª–∞–≥'],
  ['food','foods','addS','–µ–¥–∞'],
  ['friend','friends','addS','–¥—Ä—É–≥'],
  ['game','games','addS','–∏–≥—Ä–∞'],
  ['garden','gardens','addS','—Å–∞–¥'],
  ['girl','girls','addS','–¥–µ–≤–æ—á–∫–∞'],
  ['glove','gloves','addS','–ø–µ—Ä—á–∞—Ç–∫–∞'],
  ['goat','goats','addS','–∫–æ–∑–∞'],
  ['grass','grasses','sibilantEs','—Ç—Ä–∞–≤–∞'],
  ['ground','grounds','addS','–∑–µ–º–ª—è'],
  ['group','groups','addS','–≥—Ä—É–ø–ø–∞'],
  ['hand','hands','addS','—Ä—É–∫–∞'],
  ['head','heads','addS','–≥–æ–ª–æ–≤–∞'],
  ['hill','hills','addS','—Ö–æ–ª–º'],
  ['home','homes','addS','–¥–æ–º'],
  ['horse','horses','addS','–ª–æ—à–∞–¥—å'],
  ['hospital','hospitals','addS','–±–æ–ª—å–Ω–∏—Ü–∞'],
  ['idea','ideas','addS','–∏–¥–µ—è'],
  ['jam','jams','addS','–≤–∞—Ä–µ–Ω—å–µ'],
  ['job','jobs','addS','—Ä–∞–±–æ—Ç–∞'],
  ['kid','kids','addS','—Ä–µ–±—ë–Ω–æ–∫'],
  ['king','kings','addS','–∫–æ—Ä–æ–ª—å'],
  ['lake','lakes','addS','–æ–∑–µ—Ä–æ'],
  ['leg','legs','addS','–Ω–æ–≥–∞'],
  ['letter','letters','addS','–ø–∏—Å—å–º–æ'],
  ['lip','lips','addS','–≥—É–±–∞'],
  ['lock','locks','addS','–∑–∞–º–æ–∫'],
  ['map','maps','addS','–∫–∞—Ä—Ç–∞'],
  ['market','markets','addS','—Ä—ã–Ω–æ–∫'],
  ['moon','moons','addS','–ª—É–Ω–∞'],
  ['mother','mothers','addS','–º–∞—Ç—å'],
  ['mountain','mountains','addS','–≥–æ—Ä–∞'],
  ['mouth','mouths','addS','—Ä–æ—Ç'],
  ['name','names','addS','–∏–º—è'],
  ['nest','nests','addS','–≥–Ω–µ–∑–¥–æ'],
  ['night','nights','addS','–Ω–æ—á—å'],
  ['nose','noses','addS','–Ω–æ—Å'],
  ['office','offices','addS','–æ—Ñ–∏—Å'],
  ['page','pages','addS','—Å—Ç—Ä–∞–Ω–∏—Ü–∞'],
  ['pain','pains','addS','–±–æ–ª—å'],
  ['paper','papers','addS','–±—É–º–∞–≥–∞'],
  ['park','parks','addS','–ø–∞—Ä–∫'],
  ['pencil','pencils','addS','–∫–∞—Ä–∞–Ω–¥–∞—à'],
  ['picture','pictures','addS','–∫–∞—Ä—Ç–∏–Ω–∫–∞'],
  ['pig','pigs','addS','—Å–≤–∏–Ω—å—è'],
  ['plane','planes','addS','—Å–∞–º–æ–ª—ë—Ç'],
  ['plant','plants','addS','—Ä–∞—Å—Ç–µ–Ω–∏–µ'],
  ['queen','queens','addS','–∫–æ—Ä–æ–ª–µ–≤–∞'],
  ['question','questions','addS','–≤–æ–ø—Ä–æ—Å'],
  ['rat','rats','addS','–∫—Ä—ã—Å–∞'],
  ['road','roads','addS','–¥–æ—Ä–æ–≥–∞'],
  ['rock','rocks','addS','–∫–∞–º–µ–Ω—å'],
  ['room','rooms','addS','–∫–æ–º–Ω–∞—Ç–∞'],
  ['rose','roses','addS','—Ä–æ–∑–∞'],
  ['sea','seas','addS','–º–æ—Ä–µ'],
  ['ship','ships','addS','–∫–æ—Ä–∞–±–ª—å'],
  ['shirt','shirts','addS','—Ä—É–±–∞—à–∫–∞'],
  ['shop','shops','addS','–º–∞–≥–∞–∑–∏–Ω'],
  ['sister','sisters','addS','—Å–µ—Å—Ç—Ä–∞'],
  ['snake','snakes','addS','–∑–º–µ—è'],
  ['son','sons','addS','—Å—ã–Ω'],
  ['song','songs','addS','–ø–µ—Å–Ω—è'],
  ['star','stars','addS','–∑–≤–µ–∑–¥–∞'],
  ['stone','stones','addS','–∫–∞–º–µ–Ω—å'],
  ['street','streets','addS','—É–ª–∏—Ü–∞'],
  ['student','students','addS','—Å—Ç—É–¥–µ–Ω—Ç'],
  ['sun','suns','addS','—Å–æ–ª–Ω—Ü–µ'],
  ['table','tables','addS','—Å—Ç–æ–ª'],
  ['teacher','teachers','addS','—É—á–∏—Ç–µ–ª—å'],
  ['team','teams','addS','–∫–æ–º–∞–Ω–¥–∞'],
  ['thing','things','addS','–≤–µ—â—å'],
  ['time','times','addS','–≤—Ä–µ–º—è'],
  ['town','towns','addS','–≥–æ—Ä–æ–¥–æ–∫'],
  ['train','trains','addS','–ø–æ–µ–∑–¥'],
  ['tree','trees','addS','–¥–µ—Ä–µ–≤–æ'],
  ['way','ways','addS','–ø—É—Ç—å'],
  ['week','weeks','addS','–Ω–µ–¥–µ–ª—è'],
  ['window','windows','addS','–æ–∫–Ω–æ'],
  ['wood','woods','addS','–¥–µ—Ä–µ–≤–æ'],
  ['word','words','addS','—Å–ª–æ–≤–æ'],
  ['work','works','addS','—Ä–∞–±–æ—Ç–∞'],
  ['year','years','addS','–≥–æ–¥'],
  ['airport','airports','addS','–∞—ç—Ä–æ–ø–æ—Ä—Ç'],
  ['airplane','airplanes','addS','—Å–∞–º–æ–ª—ë—Ç'],
  ['animal','animals','addS','–∂–∏–≤–æ—Ç–Ω–æ–µ'],
  ['answer','answers','addS','–æ—Ç–≤–µ—Ç'],
  ['artist','artists','addS','—Ö—É–¥–æ–∂–Ω–∏–∫']
];

// ---------------- Local "DB" (localStorage) ----------------
const DB_KEY = 'pluralTrainerResultsV1';
function loadResults(){ try{ return JSON.parse(localStorage.getItem(DB_KEY) || '[]'); }catch(e){ return []; } }
function saveResult(row){ const all=loadResults(); all.push(row); localStorage.setItem(DB_KEY, JSON.stringify(all)); }
function formatTS(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function renderResultsPanel(){ const rows=loadResults().slice().sort((a,b)=>b.ts-a.ts).map(r=>`<tr>
  <td>${formatTS(r.ts)}</td>
  <td style="text-align:right">${r.words}</td>
  <td style="text-align:right">${r.raw}/${r.rawMax}</td>
  <td style="text-align:right">√ó${r.mult}</td>
  <td style="text-align:right"><b>${r.final}</b></td>
  <td style="text-align:right">${r.correct}/${r.total}</td>
  <td>${r.mode}</td>
  <td style="text-align:right">${r.avg.toFixed(2)}s</td>
</tr>`).join('') || `<tr><td colspan="8" style="text-align:center;color:#aab0d6">No saved results yet</td></tr>`;
  return `
  <h2 style="margin:6px 0 6px 0; font-size:22px">Saved Results</h2>
  <div style="max-height:48vh; overflow:auto; width:min(820px, 92vw); background:#0e1328; border:1px solid #27305a; border-radius:12px; padding:8px; margin-top:4px">
    <table style="width:100%; border-collapse:collapse; font-size:14px">
      <thead><tr>
        <th style="text-align:left;padding:6px">Date</th>
        <th style="text-align:right;padding:6px">Words</th>
        <th style="text-align:right;padding:6px">Raw</th>
        <th style="text-align:right;padding:6px">Mult</th>
        <th style="text-align:right;padding:6px">Final</th>
        <th style="text-align:right;padding:6px">Score</th>
        <th style="text-align:left;padding:6px">Mode</th>
        <th style="text-align:right;padding:6px">Avg time</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}

// ---------------- Game logic ----------------
let questions=[], round=0, locked=false, lockTimer=null, remaining=0; let stageStart=0; const stageTimes=[];
let formDone=false, ruDone=false, stageHadError=false;
let formErr=false, ruErr=false;
let points=0; // plural +1, translation +2 (only if that part had no error)
const errorStats = new Map(); // rule -> {count, words:[]}
function recordError(rule, word){ const key=rule||'addS'; const e=errorStats.get(key)||{count:0, words:[]}; e.count++; if(!e.words.includes(word) && e.words.length<2) e.words.push(word); errorStats.set(key,e);} 
let correctCount=0, totalCount=0; // score model: correct/total
const cloud=ge('cloud');
const playBtn=ge('playBtn');
let sForm=ge('sForm'), sRu=ge('sRu');
const overlay=ge('overlay'), tip=ge('tip'), dir=ge('direction'), restartBtn=ge('restart'), negSmile=ge('negSmile');
const startOverlay=ge('startOverlay');
const startBtn=ge('startBtn');
const countRow=ge('countRow');
const toggleRu=ge('toggleRu');
const badge=ge('badge');
const statusBar=ge('status');
const startPanel=ge('startPanel');
const viewResultsLink=ge('viewResultsLink');
let currentWord = '';
var ttsVoice = null;
let sampleSize = 10; // default matches selected chip
let includeTranslations = true; // toggle

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function layoutOptions(container,nodes){const n=nodes.length,cols=Math.ceil(Math.sqrt(n)),rows=Math.ceil(n/cols);const cw=container.clientWidth/cols,ch=Math.max(container.clientHeight/rows,60);const cells=[];for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) cells.push({r,c});shuffle(cells);nodes.forEach((el,i)=>{const {r,c}=cells[i];const pad=10;const x=c*cw+pad+Math.random()*(cw-el.offsetWidth-2*pad);const y=r*ch+pad+Math.random()*(ch-el.offsetHeight-2*pad);el.style.left=x+'px';el.style.top=y+'px';el.style.setProperty('--dx',(3+Math.random()*6)+'px');el.style.setProperty('--dy',(3+Math.random()*6)+'px');el.style.animationDelay=(-Math.random()*8)+'s';});}
function showNegSmile(){negSmile.classList.add('show');setTimeout(()=>negSmile.classList.remove('show'),1000);} 
function animateChoice(el,ok){
  el.classList.remove('yay','nay','flash-good','flash-bad');
  void el.offsetWidth; el.classList.add(ok? 'yay':'nay');
  el.classList.add(ok? 'flash-good':'flash-bad');
  if(ok){
    const r = el.getBoundingClientRect();
    const base = cloud.getBoundingClientRect();
    const cx = r.left - base.left + r.width/2;
    const cy = r.top  - base.top  + r.height/2;
    const fx = document.createElement('div'); fx.className = 'fx ok'; fx.style.left = cx + 'px'; fx.style.top  = cy + 'px';
    const particles = 18;
    for(let i=0;i<particles;i++){ const p = document.createElement('i'); p.style.setProperty('--a', (360/particles)*i); p.style.setProperty('--d', (40 + Math.random()*26) + 'px'); fx.appendChild(p);} cloud.appendChild(fx); setTimeout(()=>fx.remove(), 900);
  } else { showNegSmile(); }
}
function setLocked(v,seconds=0,ruleKey=''){
  locked=v; restartBtn.disabled=v; overlay.className=v?'overlay show':'overlay'; cloud.classList.toggle('locked',v);
  if(v){ remaining=seconds; tip.className='msg bad';
    const update=()=>{ const r=RULES[ruleKey]||RULES.addS; tip.innerHTML=`<b>Rule (EN):</b> ${r.en} ¬∑ <b>–ü—Ä–∞–≤–∏–ª–æ (RU):</b> ${r.ru} ¬∑ <span class=\"count\">${remaining}s</span>`; remaining--; if(remaining<0){ clearInterval(lockTimer); setLocked(false); tip.className='msg'; tip.textContent='Time is up. Try again.'; } };
    update(); lockTimer=setInterval(update,1000);
  }else{ if(lockTimer) clearInterval(lockTimer); }
}
function keepOnlyType(type, selected){
  cloud.querySelectorAll('.opt').forEach(n=>{ if(n!==selected && n.dataset.type===type){ n.classList.add('vanish'); setTimeout(()=>n.remove(),220); } });
  if(type==='ru'){ if(sRu){ sRu.classList.add('ok'); sRu.textContent='ru ‚úì'; } tip.textContent='Now choose the plural form.'; }
  if(type==='form'){ if(sForm){ sForm.classList.add('ok'); sForm.textContent='plural ‚úì'; } }
}

// ---- options builders ----
function makeWrongForms(w){
  const wrong = new Set(); const correct = w[P].toLowerCase(); const add = (s)=>{ if(s && s.toLowerCase()!==correct) wrong.add(s); };
  add(w[S]+'s'); add(w[S]+'es'); if(/[^aeiou]y$/i.test(w[S])) add(w[S]+'ys'); if(/(f|fe)$/i.test(w[S])) add(w[S].replace(/fe$/,'fes').replace(/f$/,'fs')); add(w[S]+'x'); add(w[S]+'iz'); add(w[S]+'is');
  return Array.from(wrong);
}
function buildFormOptionsOnly(w){
  const forms = new Set([w[S], w[P], ...makeWrongForms(w)]);
  const arr = Array.from(forms);
  return shuffle(arr.map(t=>({type:'form', text:t})).slice(0,7));
}
// 10 translation options (1 correct + 9 wrong)
function buildRuOptionsOnly(w){
  const ruSet = new Set([w[RU]]);
  const pool = WORDS.map(x=>x[RU]).filter(x=>x && x!==w[RU]);
  while(ruSet.size<10 && pool.length){ ruSet.add(pool[Math.floor(Math.random()*pool.length)]); }
  while(ruSet.size<10){ ruSet.add('‚Äî'); }
  return shuffle(Array.from(ruSet).slice(0,10).map(t=>({type:'ru', text:t})));
}

// ---- render steps ----
function renderTranslations(w){
  const opts = buildRuOptionsOnly(w); const els=[]; const seen=new Set();
  opts.forEach(o=>{ const key=(o.type+'|'+o.text).toLowerCase(); if(seen.has(key)) return; seen.add(key);
    const d=document.createElement('div'); d.className='opt float'; d.dataset.type=o.type; d.textContent=o.text; cloud.appendChild(d); els.push(d);
    d.onclick=()=>{ if(locked||ruDone) return; const ok=(o.text===w[RU]); animateChoice(d,ok);
      if(ok){ if(!ruErr) points += 2; ruDone=true; keepOnlyType('ru', d); renderForms(w); }
      else { ruErr=true; stageHadError=true; totalCount++; updateHUD(); recordError('translation', w[S]);
        // remove 3 wrong translations; must include the clicked wrong option
        const ruNodes = Array.from(cloud.querySelectorAll('.opt')).filter(el=>el.dataset.type==='ru');
        const wrongs = ruNodes.filter(el=>el.textContent !== w[RU]);
        const others = wrongs.filter(el=>el!==d);
        shuffle(others);
        const toRemove = [d, ...others.slice(0,2)].filter(Boolean);
        toRemove.forEach(el=>el.remove());
        const remainingRu = Array.from(cloud.querySelectorAll('.opt')).filter(el=>el.dataset.type==='ru');
        requestAnimationFrame(()=>layoutOptions(cloud, remainingRu));
        setLocked(true,5,'translation'); }
    };
  });
  requestAnimationFrame(()=>layoutOptions(cloud,els));
}
function renderForms(w){
  if(formDone) return;
  const opts = buildFormOptionsOnly(w); const els=[]; const seen=new Set();
  opts.forEach(o=>{ const key=(o.type+'|'+o.text).toLowerCase(); if(seen.has(key)) return; seen.add(key);
    const d=document.createElement('div'); d.className='opt float'; d.dataset.type=o.type; d.textContent=o.text; cloud.appendChild(d); els.push(d);
    d.onclick=()=>{ if(locked||formDone) return; const ok=(o.text.toLowerCase()===w[P].toLowerCase()); animateChoice(d,ok);
      if(ok){ if(!formErr) points += 1; formDone=true; keepOnlyType('form', d); practicePronunciation(w); }
      else { formErr=true; stageHadError=true; totalCount++; updateHUD(); const keyRule=(RULES[w[R]]?w[R]:(w[S]===w[P]?'invariant':'addS')); recordError(keyRule, w[S]); setLocked(true,5,keyRule); }
    };
  });
  requestAnimationFrame(()=>layoutOptions(cloud,els));
}

function spawn(){
  // header/status per mode
  cloud.innerHTML = '';
  if(includeTranslations){
    cloud.innerHTML = '<div class="badge">Find: translation ‚Üí plural</div><div class="status"><div class="s" id="sRu">ru</div><div class="s" id="sForm">plural</div></div>';
  } else {
    cloud.innerHTML = '<div class="badge">Find: plural</div><div class="status"><div class="s" id="sForm">plural</div></div>';
  }
  sRu=ge('sRu'); sForm=ge('sForm');
  formDone=false; ruDone=!includeTranslations; stageHadError=false; formErr=false; ruErr=false;
  const w=questions[round]; currentWord = w[S];
  if(includeTranslations){ renderTranslations(w); tip.textContent='Pick the correct translation first.'; dir.textContent='Step 1: choose translation ‚Üí Step 2: choose plural'; }
  else { renderForms(w); tip.textContent='Pick the correct plural form.'; dir.textContent='Choose plural'; }
  stageStart = performance.now();
  autoSpeakNext();
}

function maybeNext(delayMs=700){
  if(formDone && ruDone){
    const took = (performance.now() - stageStart) / 1000; stageTimes.push(took);
    if(!stageHadError){ correctCount++; }
    updateHUD();
    tip.className='msg good'; tip.textContent=`Stage solved. ${stageHadError? 'Error made ‚Üí no credit.' : 'Perfect! +1'} ¬∑ Time: ${took.toFixed(2)}s ¬∑ Avg: ${avgTime().toFixed(2)}s`;
    setTimeout(()=>{ round++; if(round>=questions.length){ showFinal(); return; } updateHUD(); spawn(); }, 700);
  }
}

function avgTime(){ if(stageTimes.length===0) return 0; return stageTimes.reduce((a,b)=>a+b,0)/stageTimes.length; }
function updateHUD(){ ge('round').textContent=(Math.min(round+1, sampleSize))+'/'+sampleSize; ge('avg').textContent = stageTimes.length? `Avg: ${avgTime().toFixed(2)}s` : 'Avg: ‚Äî'; ge('score').textContent = `${correctCount}/${totalCount}`; }

function seedQuestions(){
  // Stratified sampling: ensure at least one word from every rule group present in WORDS
  const byRule = WORDS.reduce((acc,w)=>{ (acc[w[R]] ||= []).push(w); return acc; }, {});
  const rules = Object.keys(byRule);
  // 1) mandatory: one random from each rule
  const picks = [];
  rules.forEach(rule=>{ const arr = byRule[rule]; picks.push(arr[Math.floor(Math.random()*arr.length)]); });
  // 2) fill the rest randomly from remaining pool
  const taken = new Set(picks);
  const restPool = WORDS.filter(w=>!taken.has(w));
  shuffle(restPool);
  const need = Math.max(0, sampleSize - picks.length);
  const more = restPool.slice(0, need);
  questions = shuffle([...picks, ...more]).slice(0, sampleSize);
}

function beginGame(){ correctCount=0; totalCount=sampleSize; round=0; stageTimes.length=0; points=0; errorStats.clear(); seedQuestions(); updateHUD(); startOverlay.style.display='none'; playBtn.textContent='Repeat'; spawn(); }

// Helpers to reflect selected count before starting
function getSelectedCount(){ const el = countRow.querySelector('.chip[aria-pressed="true"]'); return el? parseInt(el.dataset.n,10) : 10; }
function setIdleRoundPill(){ ge('round').textContent = '0/'+getSelectedCount(); }
setIdleRoundPill();

// ----- Start screen interactions -----
countRow.addEventListener('click',(e)=>{
  const b=e.target.closest('button.chip'); if(!b) return; [...countRow.querySelectorAll('.chip')].forEach(x=>x.setAttribute('aria-pressed','false')); b.setAttribute('aria-pressed','true'); sampleSize=parseInt(b.dataset.n,10)||10; setIdleRoundPill();
});

// Show saved results from start screen
viewResultsLink.addEventListener('click',()=>{
  startOverlay.style.display='flex';
  startPanel.innerHTML = `
    ${renderResultsPanel()}
    <div class="row" style="margin-top:8px">
      <button class="start-btn" id="startBtn">Start</button>
    </div>`;
  // re-bind start button after replacing panel content
  ge('startBtn').addEventListener('click', startClick);
});

// Start button with 3‚Üí1 countdown
function startClick(){
  includeTranslations = !!toggleRu.checked;
  sampleSize = getSelectedCount();
  if(includeTranslations){ badge.textContent='Find: translation ‚Üí plural'; dir.textContent='Step 1: choose translation ‚Üí Step 2: choose plural'; tip.textContent='Pick the correct translation first.'; }
  else { badge.textContent='Find: plural'; dir.textContent='Choose plural'; tip.textContent='Pick the correct plural form.'; }
  let n=3; const btn=ge('startBtn'); btn.textContent=n; btn.disabled=true; const iv=setInterval(()=>{ n--; btn.textContent=n>0? n : '‚Ä¶'; if(n<=0){ clearInterval(iv); beginGame(); } }, 700);
}
startBtn.addEventListener('click', startClick);

ge('restart').onclick=()=>{ if(locked) return; startOverlay.style.display='flex'; const panelHTML = `
  <div class="row" id="countRow" aria-label="Word count">
    <button class="chip" data-n="10" aria-pressed="true">10</button>
    <button class="chip" data-n="20">20</button>
    <button class="chip" data-n="35">35</button>
    <button class="chip" data-n="50">50</button>
  </div>
  <label class="toggle"><input type="checkbox" id="toggleRu" checked /> Include translations (RU)</label>
  <div class="row"><span class="link" id="viewResultsLink">View results</span></div>
  <button class="start-btn" id="startBtn">Start</button>`;
  startPanel.innerHTML = panelHTML;
  // rebind
  window.location.reload();
};

// ---- TTS (Web Speech API) ----
function pickVoice(){ const voices = window.speechSynthesis ? speechSynthesis.getVoices() : []; if(!voices || !voices.length) return null; const preferred = voices.find(v=>/^en\-US/i.test(v.lang)) || voices.find(v=>/^en\-GB/i.test(v.lang)); return preferred || voices.find(v=>/^en/i.test(v.lang)) || voices[0]; }
function updateVoice(){ ttsVoice = pickVoice(); playBtn.disabled = !ttsVoice; playBtn.textContent = ttsVoice? 'Repeat' : 'No audio'; }
function speakCurrent(){ if(!('speechSynthesis' in window)) return; if(!ttsVoice) updateVoice(); if(!ttsVoice || !currentWord) return; const u = new SpeechSynthesisUtterance(currentWord); u.voice = ttsVoice; u.lang = ttsVoice.lang || 'en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u); playBtn.textContent = 'Repeat'; }
function speakText(txt){ if(!('speechSynthesis' in window)) return; if(!ttsVoice) updateVoice(); if(!ttsVoice || !txt) return; const u=new SpeechSynthesisUtterance(txt); u.voice=ttsVoice; u.lang=ttsVoice.lang||'en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u); }
function autoSpeakNext(){ if(!('speechSynthesis' in window)) return; if(!ttsVoice){ updateVoice(); if(!ttsVoice){ const once = ()=>{ speechSynthesis.onvoiceschanged = null; updateVoice(); if(ttsVoice) speakCurrent(); }; speechSynthesis.onvoiceschanged = once; return; } } setTimeout(speakCurrent, 50); }
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = updateVoice; updateVoice(); playBtn.addEventListener('click',()=>{ speakCurrent(); }); } else { playBtn.disabled = true; playBtn.textContent = 'No audio'; }

// After correct plural: play plural, wait 500ms, then continue
function practicePronunciation(w){ speakText(w[P]); setTimeout(()=>{ maybeNext(0); }, 500); }

// ---- Final screen ----
function showFinal(){
  const multiplier = sampleSize/6; // 1/6 * N
  const scaled = Math.floor(points * multiplier);
  const entries = Array.from(errorStats.entries()).sort((a,b)=>b[1].count - a[1].count);
  let rows = entries.filter(([_,v])=>v.count>0).map(([rule,v])=>{
    const ex = v.words && v.words.length? ` (${v.words.slice(0,2).join(', ')})` : '';
    return `<tr><td>${rule}</td><td style=\"text-align:right\">${v.count}</td><td>${ex}</td></tr>`;
  }).join('');
  if(!rows) rows = `<tr><td colspan=\"3\" style=\"text-align:center;color:#aab0d6\">No errors üéâ</td></tr>`;
  const rawMax = sampleSize*3; // 2 (ru) + 1 (form)

  // Save to local DB
  saveResult({
    ts: Date.now(),
    words: sampleSize,
    raw: points,
    rawMax,
    mult: +multiplier.toFixed(2),
    final: scaled,
    correct: correctCount,
    total: totalCount,
    mode: includeTranslations? 'Translation+Plural' : 'Plural only',
    avg: +avgTime().toFixed(2)
  });

  startOverlay.style.display='flex';
  startOverlay.querySelector('.start-panel').innerHTML = `
    <div class=\"pill\">Words: ${sampleSize}</div>
    <h2 style=\"margin:6px 0 0 0; font-size:24px\">Result</h2>
    <div style=\"display:flex; gap:8px; flex-wrap:wrap; justify-content:center\">
      <div class=\"pill\">Raw points: <b>${points}</b> / ${rawMax}</div>
      <div class=\"pill\">Multiplier: √ó ${multiplier.toFixed(2)}</div>
      <div class=\"pill\">Final score: <b>${scaled}</b></div>
      <div class=\"pill\">Avg time: ${avgTime().toFixed(2)}s</div>
    </div>
    <div style=\"max-height:40vh; overflow:auto; width:min(680px, 92vw); background:#0e1328; border:1px solid #27305a; border-radius:12px; padding:8px; margin-top:8px\">
      <table style=\"width:100%; border-collapse:collapse; font-size:14px\">
        <thead><tr><th style=\"text-align:left;padding:6px\">Rule</th><th style=\"text-align:right;padding:6px\">Errors</th><th style=\"text-align:left;padding:6px\">Examples</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class=\"row\" style=\"margin-top:8px\">
      <button class=\"chip\" id=\"againBtn\">Again</button>
      <button class=\"chip\" id=\"seeResultsBtn\">See saved results</button>
    </div>`;
  const againBtn = ge('againBtn');
  const seeBtn = ge('seeResultsBtn');
  againBtn.addEventListener('click', ()=>{ startBtn.disabled=false; startBtn.textContent='Start'; setIdleRoundPill(); startOverlay.querySelector('.start-panel').innerHTML = `
        <div class=\"row\" id=\"countRow\" aria-label=\"Word count\">
          <button class=\"chip\" data-n=\"10\" aria-pressed=\"true\">10<\/button>
          <button class=\"chip\" data-n=\"20\">20<\/button>
          <button class=\"chip\" data-n=\"35\">35<\/button>
          <button class=\"chip\" data-n=\"50\">50<\/button>
        <\/div>
        <label class=\"toggle\"><input type=\"checkbox\" id=\"toggleRu\" checked \/> Include translations (RU)<\/label>
        <div class=\"row\"><span class=\"link\" id=\"viewResultsLink\">View results<\/span><\/div>
        <button class=\"start-btn\" id=\"startBtn\">Start<\/button>`;
    window.location.reload();
  });
  seeBtn.addEventListener('click',()=>{
    const panel = startOverlay.querySelector('.start-panel');
    panel.innerHTML = renderResultsPanel()+`<div class=\"row\" style=\"margin-top:8px\"><button class=\"start-btn\" id=\"startBtn\">Start<\/button><\/div>`;
    ge('startBtn').addEventListener('click', startClick);
  });
}
</script>
</body>
</html>
